<!DOCTYPE html>
<html lang="vi">

<head>
  <meta charset="UTF-8">
  <title>QUÉT QR HỌC SINH</title>
  <script src="https://unpkg.com/html5-qrcode"></script>
  <link rel="stylesheet" href="/static/css/style.css">
  <meta name="viewport" content="width=device-width, initial-scale=1">
</head>

<body>

  <h2>QUÉT QR HỌC SINH</h2>

  <button id="startBtn">Bắt đầu quét</button>

  <div id="reader"></div>

  <div id="confirm-box" style="display: none;">
    <p id="student-info"></p>
    <button onclick="finishScan()">Hoàn thành</button>
    <button onclick="continueScan()">Quét tiếp</button>
  </div>

  <hr>

  <h3>Danh sách đã quét</h3>
  <div id="scanned-list"></div>

  <button onclick="window.location.href='/giaovien/trang_chu'">Quay lại trang chủ</button>

  <script>
    let scanner = null;
    let scannedStudents = [];
    let isScanning = false;

    const readerDiv = document.getElementById("reader");
    const confirmBox = document.getElementById("confirm-box");
    const infoText = document.getElementById("student-info");
    const listDiv = document.getElementById("scanned-list");

    window.onload = () => {
      fetch("/get-scanned-list")
        .then(res => res.json())
        .then(data => {
          scannedStudents = data || [];
          renderList();
        });
    };

    document.getElementById("startBtn").onclick = () => {
      readerDiv.style.display = "block";
      startScanner();
    };

    function startScanner() {
      if (isScanning) return;

      isScanning = true;
      scanner = new Html5Qrcode("reader");

      scanner.start(
        { facingMode: "environment" },
        { fps: 10, qrbox: 250 },
        onScanSuccess,
        () => { }
      ).catch(err => {
        console.error(err);
        isScanning = false;
      });
    }

    function onScanSuccess(decodedText) {
      if (!isScanning) return;
      isScanning = false;

      scanner.stop().catch(() => { });

      infoText.innerText = "Đang xử lý...";
      confirmBox.style.display = "block";

      fetch("/qr-result", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ ma_hs: decodedText })
      })
        .then(res => res.json())
        .then(data => {
          infoText.innerText = data.message;

          if (data.status === "success" || data.status === "duplicate") {
            const hs = {
              ma_hs: data.ma_hs,
              ten: data.ten,
              lop: data.lop
            };

            if (!scannedStudents.some(s => s.ma_hs === hs.ma_hs)) {
              scannedStudents.push(hs);
              renderList();

              fetch("/add-scanned-student", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(hs)
              });
            }
          }
        });
    }

    function renderList() {
      listDiv.innerHTML = "";
      scannedStudents.forEach((hs, i) => {
        listDiv.innerHTML += `
        <p>${i + 1}. <b>${hs.ten}</b> – ${hs.lop}
        <span style="color:gray">(${hs.ma_hs})</span></p>
      `;
      });
    }

    function continueScan() {
      confirmBox.style.display = "none";
      startScanner();
    }

    function finishScan() {
      confirmBox.style.display = "none";
      readerDiv.style.display = "none";

      if (scanner) {
        scanner.clear().catch(() => { });
        scanner = null;
      }
    }
  </script>



</body>

</html>